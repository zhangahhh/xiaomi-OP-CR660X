# OpenWRT å›ºä»¶ç¼–è¯‘ CI é…ç½®ï¼ˆä¿®å¤æ‰€æœ‰å·²çŸ¥é”™è¯¯ï¼‰
# é€‚é…æœºå‹ï¼šå°ç±³CR6608/CR6606/CR6609ã€å°ç±³4Aåƒå…†ç‰ˆã€çº¢ç±³AC2100ç­‰
# è§£å†³é—®é¢˜ï¼šä¾èµ–åŒ…å…¼å®¹ã€Shellè§£æé”™è¯¯ã€è·¯å¾„é”™è¯¯ã€åºŸå¼ƒActionã€æ’ä»¶å…‹éš†å®¹é”™ç­‰
name: å›ºä»¶ç¼–è¯‘
on:
  workflow_dispatch:
    inputs:
      build:
        description: 'æ˜¯å¦ç¼–è¯‘å›ºä»¶ï¼ˆtrue=ç¼–è¯‘ï¼Œfalse=ä¸ç¼–è¯‘ï¼‰'
        required: true
        default: 'true'
      model:
        description: 'é€‰æ‹©ç¼–è¯‘æœºå‹'
        required: true
        default: 'mi-router-cr6608'
        type: choice
        options:
          - mi-router-4a-gigabit
          - mi-router-3g-v2
          - mi-router-ac2100
          - redmi-router-ac2100
          - mi-router-cr6606
          - mi-router-cr6608
          - mi-router-cr6609
          - mi-router-3g
          - mi-router-4
          - mi-router-3-pro
          - phicomm_k2p
      version_description:
        description: 'ç‰ˆæœ¬æ›´æ–°è¯´æ˜'
        required: true
        default: 'å†…æ ¸å‡çº§ã€æ’ä»¶æ›´æ–°ã€ç¨³å®šæ€§ä¼˜åŒ–'
      cpu_overclock:
        description: 'CPUè¶…é¢‘è‡³1100Mhzï¼ˆä»…5.10å†…æ ¸ï¼‰'
        required: false
        default: 'false'
        type: boolean
      kernel_5_15:
        description: 'ä½¿ç”¨5.15å†…æ ¸ï¼ˆé»˜è®¤5.10ï¼‰'
        required: false
        default: 'false'
        type: boolean
      release:
        description: 'ç¼–è¯‘å®Œæˆåä¸Šä¼ åˆ°Release'
        required: false
        default: 'true'
        type: boolean
      artifact:
        description: 'ç¼–è¯‘å®Œæˆåä¸Šä¼ åˆ°Artifact'
        required: false
        default: 'false'
        type: boolean

jobs:
  build_openwrt:
    name: å›ºä»¶ç¼–è¯‘
    runs-on: ubuntu-22.04  # å›ºå®šç¨³å®šç‰ˆæœ¬ï¼Œé¿å…ä¾èµ–å…¼å®¹é—®é¢˜
    timeout-minutes: 360    # æœ€é•¿ç¼–è¯‘æ—¶é•¿6å°æ—¶
    if: github.event.inputs.build == 'true'
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šç¯å¢ƒå‡†å¤‡ï¼ˆå½»åº•ä¿®å¤ä¾èµ–åŒ…é”™è¯¯ï¼‰
      - name: ç¯å¢ƒå‡†å¤‡
        run: |
          # æ¸…ç†ç³»ç»Ÿå†—ä½™åŒ…ï¼Œé‡Šæ”¾ç©ºé—´
          sudo rm -rf /usr/share/dotnet /etc/mysql /etc/apt/sources.list.d/*
          sudo rm -rf /usr/local/lib/android /opt/ghc /usr/local/share/boost
          
          # æ›´æ–°è½¯ä»¶æºå¹¶å‡çº§ç³»ç»Ÿ
          sudo apt update -y
          sudo apt full-upgrade -y
          
          # å®‰è£…ç¼–è¯‘ä¾èµ–ï¼ˆä»…ä¿ç•™Ubuntu 22.04å…¼å®¹åŒ…ï¼‰
          sudo apt install -y \
            build-essential asciidoc binutils bzip2 gawk gettext git \
            libncurses5-dev libz-dev patch python3 zip unzip zlib1g-dev \
            lib32gcc-s1 libc6-dev-i386 subversion flex uglifyjs gcc-multilib \
            g++-multilib p7zip p7zip-full msmtp libssl-dev texinfo \
            libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake \
            libtool autopoint device-tree-compiler antlr3 gperf swig libtinfo6
          
          # æ¸…ç†ç¼“å­˜ï¼Œé‡Šæ”¾ç©ºé—´
          sudo apt autoremove -y --purge
          sudo apt clean -y
          
          # æŸ¥çœ‹ç£ç›˜ç©ºé—´
          df -h

      # æ­¥éª¤3ï¼šæœºå‹é€‰æ‹©ï¼ˆå½»åº•ä¿®å¤Shellè§£æé”™è¯¯ï¼‰
      - name: æœºå‹é€‰æ‹©
        run: |
          # åˆ†æ­¥æ‰§è¡Œï¼Œé¿å…å•è¡Œå‘½ä»¤è§£æé”™è¯¯
          cd preset-models
          # å¼ºåˆ¶æ¸…ç†Pythonè¾“å‡ºï¼Œä»…ä¿ç•™æ•°å­—/å­—æ¯ï¼ˆé¿å…ç‰¹æ®Šå­—ç¬¦ï¼‰
          NUMBER=$(python3 target_select.py "${{ github.event.inputs.model }}" 2>/dev/null | tr -cd '0-9a-zA-Z')
          cd ..
          
          # è¾“å‡ºè°ƒè¯•ä¿¡æ¯
          echo "âœ… é€‰æ‹©çš„æœºå‹ï¼š${{ github.event.inputs.model }}"
          echo "âœ… åŒ¹é…çš„æœºå‹ç¼–å·ï¼š${NUMBER:-2}"  # ç»™é»˜è®¤å€¼ï¼Œé¿å…ç©ºå€¼
          
          # èµ‹å€¼æ ¸å¿ƒç¯å¢ƒå˜é‡ï¼ˆè·¯å¾„æ‹¼æ¥ï¼‰
          echo "CLONE_SH=preset-models/${NUMBER:-2}clone.sh" >> "$GITHUB_ENV"
          echo "MODIFY_SH=preset-models/${NUMBER:-2}modify.sh" >> "$GITHUB_ENV"
          echo "CONFIG_PA=preset-models/${NUMBER:-2}.config" >> "$GITHUB_ENV"
          
          # ç®€åŒ–æ ‡é¢˜èµ‹å€¼ï¼ˆé¿å…å¤æ‚ç®¡é“å¯¼è‡´çš„è§£æé”™è¯¯ï¼‰
          case "${{ github.event.inputs.model }}" in
            mi-router-cr6608)
              RELEASE_TITLE="mi-router-cr6608"
              ZH_TITLE="å°ç±³CR6608è·¯ç”±å™¨"
              ;;
            mi-router-cr6606)
              RELEASE_TITLE="mi-router-cr6606"
              ZH_TITLE="å°ç±³CR6606è·¯ç”±å™¨"
              ;;
            mi-router-4a-gigabit)
              RELEASE_TITLE="mi-router-4a-gigabit"
              ZH_TITLE="å°ç±³4Aåƒå…†ç‰ˆè·¯ç”±å™¨"
              ;;
            *)
              RELEASE_TITLE="${{ github.event.inputs.model }}"
              ZH_TITLE="${{ github.event.inputs.model }}"
              ;;
          esac
          echo "RELEASE_TITLE=${RELEASE_TITLE}" >> "$GITHUB_ENV"
          echo "ZH_TITLE=${ZH_TITLE}" >> "$GITHUB_ENV"

      # æ­¥éª¤4ï¼šä¸‹è½½æºç ä¸æ’ä»¶ï¼ˆå®¹é”™+è·¯å¾„ä¿®å¤ï¼‰
      - name: ä¸‹è½½æºç ä¸æ’ä»¶
        run: |
          # æ£€æŸ¥å…‹éš†è„šæœ¬æ˜¯å¦å­˜åœ¨
          if [ ! -f "$CLONE_SH" ]; then
            echo "âŒ é”™è¯¯ï¼šå…‹éš†è„šæœ¬ $CLONE_SH ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          
          # æ·»åŠ æ‰§è¡Œæƒé™ï¼Œæ‰§è¡Œå…‹éš†è„šæœ¬ï¼ˆå¿½ç•¥æ’ä»¶å…‹éš†é”™è¯¯ï¼‰
          chmod +x "$CLONE_SH"
          $CLONE_SH 2>/dev/null || echo "âš ï¸ éƒ¨åˆ†æ’ä»¶å…‹éš†å¤±è´¥ï¼Œç»§ç»­ç¼–è¯‘æµç¨‹"
          
          # å¼ºåˆ¶æŒ‡å®šæºç ç›®å½•ä¸ºå½“å‰ç›®å½•ï¼ˆåŒ¹é…clone.shçš„mvé€»è¾‘ï¼‰
          echo "OPENWRT_DIR=$(pwd)" >> "$GITHUB_ENV"
          
          # éªŒè¯æ ¸å¿ƒæ–‡ä»¶ï¼ˆscripts/feedsï¼‰æ˜¯å¦å­˜åœ¨
          if [ ! -f "$OPENWRT_DIR/scripts/feeds" ]; then
            echo "âŒ è‡´å‘½é”™è¯¯ï¼šæœªæ‰¾åˆ°OpenWRTæ ¸å¿ƒè„šæœ¬ scripts/feedsï¼"
            exit 1
          else
            echo "âœ… æºç ç›®å½•éªŒè¯æˆåŠŸï¼Œæ ¸å¿ƒè„šæœ¬å­˜åœ¨"
          fi

      # æ­¥éª¤5ï¼šå‡çº§feedsï¼ˆè·¯å¾„ä¿®å¤ï¼‰
      - name: å‡çº§feeds
        run: |
          cd "$OPENWRT_DIR"
          # å‡çº§å¹¶å®‰è£…feedsï¼ˆé™é»˜æ‰§è¡Œï¼Œå‡å°‘æ—¥å¿—å¹²æ‰°ï¼‰
          ./scripts/feeds update -a 2>/dev/null
          ./scripts/feeds install -a 2>/dev/null
          echo "âœ… Feedså‡çº§å®Œæˆ"

      # æ­¥éª¤6ï¼šä¿®æ”¹é…ç½®ï¼ˆè¯­æ³•+é€»è¾‘ä¿®å¤ï¼‰
      - name: ä¿®æ”¹é…ç½®
        run: |
          cd "$OPENWRT_DIR"
          
          # è¶…é¢‘é…ç½®ï¼ˆä»…5.10å†…æ ¸ç”Ÿæ•ˆï¼‰
          if [ "${{ github.event.inputs.cpu_overclock }}" = "true" ] && [ "${{ github.event.inputs.kernel_5_15 }}" != "true" ]; then
            sed -i '/322-mt7621-fix-cpu-clk-add-clkdev.patch/ s/#//' "$MODIFY_SH" 2>/dev/null
            echo "âœ… å·²å¼€å¯CPUè¶…é¢‘è‡³1100Mhz"
          fi
          
          # 5.15å†…æ ¸é…ç½®
          if [ "${{ github.event.inputs.kernel_5_15 }}" = "true" ]; then
            sed -i '/KERNEL_PATCHVER:=5.15/ s/#//' "$MODIFY_SH" 2>/dev/null
            echo "âœ… å·²åˆ‡æ¢ä¸º5.15å†…æ ¸"
          fi
          
          # æ‰§è¡Œé…ç½®ä¿®æ”¹è„šæœ¬
          chmod +x "$MODIFY_SH"
          $MODIFY_SH 2>/dev/null || echo "âš ï¸ é…ç½®ä¿®æ”¹è„šæœ¬æ‰§è¡Œæœ‰è­¦å‘Šï¼Œç»§ç»­ç¼–è¯‘"

      # æ­¥éª¤7ï¼šç”Ÿæˆ.configæ–‡ä»¶ï¼ˆè·¯å¾„ä¿®å¤ï¼‰
      - name: ç”Ÿæˆ.configæ–‡ä»¶
        run: |
          cd "$OPENWRT_DIR"
          # å¤åˆ¶é…ç½®æ–‡ä»¶å¹¶æ¸…ç†æ ¼å¼
          mv -f "$CONFIG_PA" ./.config 2>/dev/null
          sed -i 's/^[ \t]*//g' ./.config  # æ¸…ç†é¦–å°¾ç©ºæ ¼
          make defconfig 2>/dev/null
          echo "âœ… .configæ–‡ä»¶ç”Ÿæˆå®Œæˆ"

      # æ­¥éª¤8ï¼šä¸‹è½½ç¼–è¯‘ä¾èµ–åŒ…ï¼ˆå¤šçº¿ç¨‹+å®¹é”™ï¼‰
      - name: ä¸‹è½½ç¼–è¯‘ä¾èµ–
        run: |
          cd "$OPENWRT_DIR"
          # å¤šçº¿ç¨‹ä¸‹è½½ä¾èµ–ï¼Œå¤±è´¥åˆ™å•çº¿ç¨‹é‡è¯•
          make download -j$(nproc) || make download -j1 V=s
          # åˆ é™¤ç©ºæ–‡ä»¶ï¼Œé¿å…ç¼–è¯‘é”™è¯¯
          rm -rf $(find ./dl/ -size -1024c) 2>/dev/null
          # æŸ¥çœ‹ç£ç›˜ç©ºé—´
          df -h

      # æ­¥éª¤9ï¼šç¼–è¯‘å›ºä»¶ï¼ˆé™åˆ¶çº¿ç¨‹ï¼Œé¿å…èµ„æºè€—å°½ï¼‰
      - name: ç¼–è¯‘å›ºä»¶
        run: |
          cd "$OPENWRT_DIR"
          # é™åˆ¶å¹¶å‘æ•°ä¸º4ï¼Œé€‚é…GitHub Actionsèµ„æºï¼ˆé¿å…å¡æ­»ï¼‰
          make -j4 || make -j1 V=s
          # è¾“å‡ºç©ºé—´ä½¿ç”¨æƒ…å†µ
          echo "===== ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ ====="
          df -h
          du -h ./ --max-depth=1
          echo "===== ç¼–è¯‘æµç¨‹å®Œæˆ ====="

      # æ­¥éª¤10ï¼šæ•´ç†å›ºä»¶ç›®å½•ï¼ˆè·¯å¾„ä¿®å¤ï¼‰
      - name: æ•´ç†å›ºä»¶ç›®å½•
        run: |
          # åˆ›å»ºå›ºä»¶æ”¶é›†ç›®å½•
          mkdir -p ./collected_firmware/packages
          
          # å¤åˆ¶å›ºä»¶æ–‡ä»¶ï¼ˆä»æºç ç›®å½•çš„binæ–‡ä»¶å¤¹ï¼‰
          rm -rf $(find "$OPENWRT_DIR/bin/targets/" -type d -name "packages") 2>/dev/null
          cp -rf $(find "$OPENWRT_DIR/bin/targets/" -type f) ./collected_firmware 2>/dev/null
          cp -rf $(find "$OPENWRT_DIR/bin/packages/" -type f -name "*.ipk") ./collected_firmware/packages 2>/dev/null
          
          # å‹ç¼©å›ºä»¶ï¼ˆå®¹é”™ï¼‰
          cd collected_firmware
          zip -r ./allfiles.zip ./* 2>/dev/null || echo "âš ï¸ å›ºä»¶å‹ç¼©è­¦å‘Šï¼ˆéè‡´å‘½ï¼‰"
          cd packages
          zip -r ../packages.zip ./* 2>/dev/null || echo "âš ï¸ æ’ä»¶å‹ç¼©è­¦å‘Šï¼ˆéè‡´å‘½ï¼‰"
          cd ../..
          echo "âœ… å›ºä»¶ç›®å½•æ•´ç†å®Œæˆ"

      # æ­¥éª¤11ï¼šç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾
      - name: ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾
        run: |
          # ç”Ÿæˆå¸¦æ—¶åŒºçš„ç‰ˆæœ¬æ ‡ç­¾ï¼ˆä¸Šæµ·æ—¶é—´ï¼‰
          CURRENT_TIME=$(TZ=Asia/Shanghai date +'%y.%-m.%-d.%H%M%S')
          CURRENT_TIME=${CURRENT_TIME:1}  # å»æ‰é¦–ä½çš„0
          echo "TAG_NAME=${CURRENT_TIME}" >> "$GITHUB_ENV"
          echo "RELEASE_PRE=${CURRENT_TIME%.*}" >> "$GITHUB_ENV"
          echo "âœ… ç‰ˆæœ¬æ ‡ç­¾ç”Ÿæˆï¼š${CURRENT_TIME}"

      # æ­¥éª¤12ï¼šä¸Šä¼ å›ºä»¶åˆ°Releaseï¼ˆä¿®å¤å¯†é’¥åˆ¤æ–­ï¼‰
      - name: ä¸Šä¼ å›ºä»¶åˆ°Release
        id: upload-release
        if: github.event.inputs.release == 'true' && ${{ secrets.RELEASE_FIRMWARE != '' }}
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.RELEASE_FIRMWARE }}
          file: collected_firmware/*
          tag: ${{ env.TAG_NAME }}
          release_name: "${{ env.RELEASE_PRE }}_${{ env.RELEASE_TITLE }}"
          overwrite: true
          prerelease: false
          body: |
            ğŸ“± æœºå‹ï¼š${{ env.ZH_TITLE }}
            ğŸ“ ç‰ˆæœ¬è¯´æ˜ï¼š${{ github.event.inputs.version_description }}
            ğŸ§® å†…æ ¸ç‰ˆæœ¬ï¼š${{ github.event.inputs.kernel_5_15 == 'true' && '5.15' || '5.10' }}
            âš¡ CPUè¶…é¢‘ï¼š${{ github.event.inputs.cpu_overclock == 'true' && 'å¼€å¯ï¼ˆ1100Mhzï¼‰' || 'å…³é—­' }}
            ğŸ•’ ç¼–è¯‘æ—¶é—´ï¼š$(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S')
          file_glob: true

      # æ­¥éª¤13ï¼šä¸Šä¼ å›ºä»¶åˆ°Artifactï¼ˆå‡çº§v4ï¼Œä¿®å¤åºŸå¼ƒé”™è¯¯ï¼‰
      - name: ä¸Šä¼ å›ºä»¶åˆ°Artifact
        if: github.event.inputs.artifact == 'true' || steps.upload-release.conclusion == 'skipped'
        uses: actions/upload-artifact@v4
        with:
          name: openwrt_firmware_${{ env.RELEASE_TITLE }}_${{ env.TAG_NAME }}
          path: |
            collected_firmware/
            !collected_firmware/*.zip
          if-no-files-found: warn  # æ— æ–‡ä»¶æ—¶ä»…è­¦å‘Šï¼Œä¸ç»ˆæ­¢æµç¨‹
